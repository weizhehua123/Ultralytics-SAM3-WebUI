<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAM3 - Segment Anything Model 3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            color: white;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4); }
        .btn-secondary {
            padding: 12px 24px;
            background: #334155;
            color: white;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover { background: #475569; transform: scale(1.05); }
        .card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
        }
        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
        }
        .input-field:focus { outline: none; border-color: #3b82f6; }
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-btn { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; transition: all 0.3s; }
        .tab-btn.active { background: #3b82f6; color: white; }
        .tab-btn:not(.active) { color: #94a3b8; }
        .tab-btn:not(.active):hover { color: white; background: rgba(51, 65, 85, 0.5); }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="#" onclick="showPage('home')" class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold gradient-text">SAM3</span>
                </a>
                <div class="flex items-center space-x-1">
                    <button onclick="showPage('home')" id="nav-home" class="px-4 py-2 rounded-lg text-sm font-medium text-blue-400 bg-blue-500/20">首页</button>
                    <button onclick="showPage('image')" id="nav-image" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50">图片分割</button>
                    <button onclick="showPage('video')" id="nav-video" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50">视频跟踪</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="page-home" class="page active pt-16">
        <section class="relative py-20 lg:py-32 overflow-hidden">
            <div class="absolute inset-0 overflow-hidden">
                <div class="absolute -top-1/2 -right-1/4 w-[800px] h-[800px] bg-blue-500/10 rounded-full blur-3xl"></div>
                <div class="absolute -bottom-1/2 -left-1/4 w-[600px] h-[600px] bg-cyan-500/10 rounded-full blur-3xl"></div>
            </div>
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <div class="inline-flex items-center space-x-2 px-4 py-2 bg-blue-500/10 border border-blue-500/30 rounded-full mb-8">
                        <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                        <span class="text-sm text-blue-400 font-medium">Powered by Ultralytics</span>
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold mb-6">
                        <span class="gradient-text">Segment Anything</span><br/>
                        <span class="text-white">Model 3</span>
                    </h1>
                    <p class="text-xl text-slate-400 max-w-2xl mx-auto mb-12">
                        基于文本和图像提示的先进分割与跟踪系统。<br/>
                        支持图片分割和视频跟踪，让AI理解你的视觉需求。
                    </p>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <button onclick="showPage('image')" class="btn-primary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>开始图片分割</span>
                        </button>
                        <button onclick="showPage('video')" class="btn-secondary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span>开始视频跟踪</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">核心功能</h2>
                    <p class="text-slate-400">SAM3 提供强大的图像和视频处理能力</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-blue-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">文本概念分割</h3>
                        <p class="text-slate-400">通过自然语言描述，让AI理解并分割出你需要的对象。</p>
                    </div>
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-purple-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">图像样本分割</h3>
                        <p class="text-slate-400">上传参考图像，AI会学习样本特征并分割相似对象。</p>
                    </div>
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-green-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">多重查询</h3>
                        <p class="text-slate-400">复用图像特征进行多次查询，提高处理效率。</p>
                    </div>
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-orange-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">边界框跟踪</h3>
                        <p class="text-slate-400">在视频中使用边界框跟踪对象，实时追踪目标。</p>
                    </div>
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-cyan-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">文本提示跟踪</h3>
                        <p class="text-slate-400">通过文本描述在视频中跟踪特定对象。</p>
                    </div>
                    <div class="card">
                        <div class="w-14 h-14 rounded-xl bg-indigo-500/20 flex items-center justify-center mb-6">
                            <svg class="w-7 h-7 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">高性能处理</h3>
                        <p class="text-slate-400">基于Ultralytics优化，提供快速准确的推理能力。</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Image Page -->
    <div id="page-image" class="page pt-16">
        <div class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-white mb-2">图片分割</h1>
                <p class="text-slate-400 mb-8">使用SAM3对图片进行智能分割</p>
                
                <div class="flex space-x-1 mb-8 bg-slate-800/50 p-1 rounded-xl w-fit">
                    <button onclick="setImageMode('text')" id="img-mode-text" class="tab-btn active">文本分割</button>
                    <button onclick="setImageMode('image')" id="img-mode-image" class="tab-btn">图像样本</button>
                    <button onclick="setImageMode('multi')" id="img-mode-multi" class="tab-btn">多重查询</button>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="space-y-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">上传图片</h3>
                            <div id="image-drop-zone" onclick="document.getElementById('image-input').click()" class="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:border-blue-500/50 transition-colors cursor-pointer">
                                <svg class="w-12 h-12 text-slate-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-slate-400">点击或拖拽上传图片</p>
                                <p class="text-slate-500 text-sm mt-2">支持 JPG, PNG, WebP</p>
                            </div>
                            <div id="image-preview-container" class="hidden relative">
                                <img id="image-preview" class="w-full h-48 object-cover rounded-lg">
                                <button onclick="clearImage()" class="absolute top-2 right-2 w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <input id="image-input" type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        </div>
                        
                        <div id="text-prompt-section" class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">文本提示</h3>
                            <textarea id="text-prompt" placeholder="描述要分割的对象，例如：'一只猫'..." class="input-field h-24 resize-none"></textarea>
                        </div>
                        
                        <div id="image-sample-section" class="card hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">样本提示（示例框）</h3>
                            <textarea id="exemplar-bboxes" placeholder='示例：[[100,120,350,420]] 或 [[x1,y1,x2,y2],[...]]' class="input-field h-24 resize-none"></textarea>
                            <p class="text-slate-500 text-sm mt-2">说明：SAM3 的“图像样本”以目标图像上的示例框作为 exemplar 提示。</p>
                        </div>

                        <div id="multi-prompt-section" class="card hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">多重查询（文本）</h3>
                            <textarea id="multi-prompts" placeholder="示例：person, bicycle, bus" class="input-field h-24 resize-none"></textarea>
                            <p class="text-slate-500 text-sm mt-2">会先提取一次图像特征，再按多个 prompt 依次查询。</p>
                        </div>
                        
                        <button onclick="processSegmentation()" id="segment-btn" class="w-full btn-primary justify-center" disabled>
                            <span id="segment-spinner" class="spinner hidden"></span>
                            <span id="segment-text">开始分割</span>
                        </button>
                    </div>
                    
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">分割结果</h3>
                            <div class="bg-slate-900 rounded-xl border border-slate-700 flex items-center justify-center" style="min-height: 500px;">
                                <div id="image-placeholder" class="text-center">
                                    <svg class="w-20 h-20 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-slate-500">上传图片以开始分割</p>
                                </div>
                                <img id="result-image" class="hidden max-w-full max-h-[500px] object-contain">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Page -->
    <div id="page-video" class="page pt-16">
        <div class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-white mb-2">视频跟踪</h1>
                <p class="text-slate-400 mb-8">使用SAM3在视频中跟踪对象</p>
                
                <div class="flex space-x-1 mb-8 bg-slate-800/50 p-1 rounded-xl w-fit">
                    <button onclick="setVideoMode('bbox')" id="vid-mode-bbox" class="tab-btn active">边界框跟踪</button>
                    <button onclick="setVideoMode('text')" id="vid-mode-text" class="tab-btn">文本提示跟踪</button>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="space-y-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">上传视频</h3>
                            <div onclick="document.getElementById('video-input').click()" class="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:border-blue-500/50 transition-colors cursor-pointer">
                                <svg class="w-12 h-12 text-slate-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-slate-400">点击或拖拽上传视频</p>
                                <p class="text-slate-500 text-sm mt-2">支持 MP4, WebM, MOV</p>
                            </div>
                            <div id="video-preview-container" class="hidden relative">
                                <video id="video-preview" controls class="w-full h-48 object-cover rounded-lg"></video>
                                <button onclick="clearVideo()" class="absolute top-2 right-2 w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <input id="video-input" type="file" accept="video/*" class="hidden" onchange="handleVideoUpload(event)">
                        </div>
                        
                        <div id="video-bbox-section" class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">初始边界框（JSON）</h3>
                            <textarea id="video-bboxes" class="input-field h-24 resize-none">[[100,100,400,400]]</textarea>
                            <p class="text-slate-500 text-sm mt-2">格式：[[x1,y1,x2,y2]]，像素坐标。</p>
                        </div>

                        <div id="video-text-section" class="card hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">文本提示</h3>
                            <textarea id="video-prompt" placeholder="描述要跟踪的对象..." class="input-field h-24 resize-none"></textarea>
                        </div>
                        
                        <div class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">跟踪设置</h3>
                            <label class="text-slate-400 text-sm">置信度阈值</label>
                            <input type="range" min="0" max="1" step="0.05" value="0.5" class="w-full mt-2">
                            <label class="text-slate-400 text-sm mt-4 block">跟踪模式</label>
                            <select class="input-field text-sm mt-2">
                                <option value="single">单目标跟踪</option>
                                <option value="multi">多目标跟踪</option>
                            </select>
                        </div>
                        
                        <button onclick="processTracking()" id="track-btn" class="w-full btn-primary justify-center" disabled>
                            <span id="track-spinner" class="spinner hidden"></span>
                            <span id="track-text">开始跟踪</span>
                        </button>
                    </div>
                    
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-lg font-semibold text-white mb-4">视频预览</h3>
                            <div class="bg-slate-900 rounded-xl border border-slate-700 aspect-video flex items-center justify-center">
                                <div id="video-placeholder" class="text-center">
                                    <svg class="w-20 h-20 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-slate-500">上传视频以开始跟踪</p>
                                </div>
                                <video id="result-video" controls class="hidden w-full h-full"></video>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            
            document.querySelectorAll('[id^="nav-"]').forEach(n => {
                n.classList.remove('text-blue-400', 'bg-blue-500/20');
                n.classList.add('text-slate-400');
            });
            document.getElementById('nav-' + page).classList.add('text-blue-400', 'bg-blue-500/20');
            document.getElementById('nav-' + page).classList.remove('text-slate-400');
        }
        
        // Image Mode
        let currentImageMode = 'text';
        let hasImage = false;
        
        function setImageMode(mode) {
            currentImageMode = mode;
            document.querySelectorAll('[id^="img-mode-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById('img-mode-' + mode).classList.add('active');
            
            document.getElementById('text-prompt-section').classList.toggle('hidden', mode !== 'text');
            document.getElementById('image-sample-section').classList.toggle('hidden', mode !== 'image');
            document.getElementById('multi-prompt-section').classList.toggle('hidden', mode !== 'multi');
            updateSegmentButton();
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById('image-preview').src = url;
                document.getElementById('result-image').src = url;
                document.getElementById('image-drop-zone').classList.add('hidden');
                document.getElementById('image-preview-container').classList.remove('hidden');
                document.getElementById('image-placeholder').classList.add('hidden');
                document.getElementById('result-image').classList.remove('hidden');
                hasImage = true;
                updateSegmentButton();
            }
        }
        
        function clearImage() {
            document.getElementById('image-preview').src = '';
            document.getElementById('result-image').src = '';
            document.getElementById('image-drop-zone').classList.remove('hidden');
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('image-placeholder').classList.remove('hidden');
            document.getElementById('result-image').classList.add('hidden');
            hasImage = false;
            updateSegmentButton();
        }
        
        function updateSegmentButton() {
            const btn = document.getElementById('segment-btn');
            if (currentImageMode === 'text') {
                btn.disabled = !hasImage || !document.getElementById('text-prompt').value.trim();
            } else if (currentImageMode === 'multi') {
                btn.disabled = !hasImage || !document.getElementById('multi-prompts').value.trim();
            } else {
                btn.disabled = !hasImage;
            }
        }
        
        document.getElementById('text-prompt').addEventListener('input', updateSegmentButton);
        document.getElementById('exemplar-bboxes').addEventListener('input', updateSegmentButton);
        document.getElementById('multi-prompts').addEventListener('input', updateSegmentButton);

        async function apiPostForm(url, formData) {
            const res = await fetch(url, { method: 'POST', body: formData });
            if (!res.ok) {
                const t = await res.text();
                throw new Error(t || ('HTTP ' + res.status));
            }
            return await res.json();
        }

        async function apiPostJson(url, payload) {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const t = await res.text();
                throw new Error(t || ('HTTP ' + res.status));
            }
            return await res.json();
        }

        async function pollJob(jobId, { timeoutMs = 10 * 60 * 1000, onUpdate = null } = {}) {
            const t0 = Date.now();
            while (true) {
                const res = await fetch('/api/v1/jobs/' + jobId);
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t || ('HTTP ' + res.status));
                }
                const job = await res.json();
                if (onUpdate) onUpdate(job);
                if (job.status === 'succeeded' || job.status === 'failed') return job;
                if (Date.now() - t0 > timeoutMs) throw new Error('job timeout: ' + jobId);
                await new Promise(r => setTimeout(r, 800));
            }
        }
        
        function processSegmentation() {
            const btn = document.getElementById('segment-btn');
            const spinner = document.getElementById('segment-spinner');
            const text = document.getElementById('segment-text');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            text.textContent = '处理中...';

            (async () => {
                try {
                    const imageFile = document.getElementById('image-input').files[0];
                    if (!imageFile) throw new Error('请先上传图片');

                    let jobId = null;

                    if (currentImageMode === 'text') {
                        const prompt = document.getElementById('text-prompt').value.trim();
                        const fd = new FormData();
                        fd.append('image', imageFile);
                        fd.append('prompt', prompt);
                        const r = await apiPostForm('/api/v1/image/segment/text', fd);
                        jobId = r.job_id;
                    } else if (currentImageMode === 'image') {
                        const bboxesJson = document.getElementById('exemplar-bboxes').value.trim() || '[]';
                        const fd = new FormData();
                        fd.append('image', imageFile);
                        fd.append('bboxes_json', bboxesJson);
                        const r = await apiPostForm('/api/v1/image/segment/exemplar', fd);
                        jobId = r.job_id;
                    } else {
                        // multi: embedding -> query each prompt sequentially (show last overlay/mask)
                        const prompts = document.getElementById('multi-prompts').value.split(',').map(s => s.trim()).filter(Boolean);
                        const fdEmb = new FormData();
                        fdEmb.append('image', imageFile);
                        const embResp = await apiPostForm('/api/v1/image/embedding', fdEmb);
                        const embJob = await pollJob(embResp.job_id);
                        if (embJob.status !== 'succeeded') throw new Error(embJob.error?.message || 'embedding failed');
                        const embeddingId = embJob.result?.meta?.embedding_id;
                        if (!embeddingId) throw new Error('embedding_id not found');

                        for (const p of prompts) {
                            const qResp = await apiPostJson('/api/v1/image/query', { embedding_id: embeddingId, query: { type: 'text', prompt: p } });
                            const qJob = await pollJob(qResp.job_id);
                            if (qJob.status !== 'succeeded') throw new Error(qJob.error?.message || 'query failed');
                            const masks = qJob.result?.files?.masks || [];
                            if (masks.length > 0) {
                                document.getElementById('result-image').src = masks[0];
                                document.getElementById('result-image').classList.remove('hidden');
                                document.getElementById('image-placeholder').classList.add('hidden');
                            }
                        }

                        return;
                    }

                    const job = await pollJob(jobId, {
                        onUpdate: (j) => {
                            const p = (typeof j.progress === 'number') ? Math.round(j.progress * 100) : null;
                            text.textContent = '处理中...' + (p !== null ? (' ' + p + '%') : '');
                        }
                    });
                    if (job.status !== 'succeeded') throw new Error(job.error?.message || 'job failed');

                    const overlay = job.result?.files?.overlay;
                    const masks = job.result?.files?.masks || [];
                    const showUrl = overlay || (masks.length ? masks[0] : null);
                    if (!showUrl) throw new Error('no result files');

                    document.getElementById('result-image').src = showUrl;
                    document.getElementById('result-image').classList.remove('hidden');
                    document.getElementById('image-placeholder').classList.add('hidden');
                } catch (e) {
                    alert('分割失败：' + (e.message || e));
                } finally {
                    spinner.classList.add('hidden');
                    text.textContent = '开始分割';
                    updateSegmentButton();
                }
            })();
        }
        
        // Video Mode
        let currentVideoMode = 'bbox';
        let hasVideo = false;
        
        function setVideoMode(mode) {
            currentVideoMode = mode;
            document.querySelectorAll('[id^="vid-mode-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById('vid-mode-' + mode).classList.add('active');
            document.getElementById('video-text-section').classList.toggle('hidden', mode !== 'text');
            document.getElementById('video-bbox-section').classList.toggle('hidden', mode !== 'bbox');
        }
        
        function handleVideoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById('video-preview').src = url;
                document.getElementById('result-video').src = url;
                document.getElementById('video-preview-container').classList.remove('hidden');
                document.getElementById('video-placeholder').classList.add('hidden');
                document.getElementById('result-video').classList.remove('hidden');
                hasVideo = true;
                document.getElementById('track-btn').disabled = false;
            }
        }
        
        function clearVideo() {
            document.getElementById('video-preview').src = '';
            document.getElementById('result-video').src = '';
            document.getElementById('video-preview-container').classList.add('hidden');
            document.getElementById('video-placeholder').classList.remove('hidden');
            document.getElementById('result-video').classList.add('hidden');
            hasVideo = false;
            document.getElementById('track-btn').disabled = true;
        }
        
        function processTracking() {
            const btn = document.getElementById('track-btn');
            const spinner = document.getElementById('track-spinner');
            const text = document.getElementById('track-text');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            text.textContent = '处理中...';

            (async () => {
                try {
                    const videoFile = document.getElementById('video-input').files[0];
                    if (!videoFile) throw new Error('请先上传视频');

                    let jobId = null;
                    if (currentVideoMode === 'bbox') {
                        const b = document.getElementById('video-bboxes').value.trim() || '[]';
                        const fd = new FormData();
                        fd.append('video', videoFile);
                        fd.append('init_bboxes_json', b);
                        const r = await apiPostForm('/api/v1/video/track/bbox', fd);
                        jobId = r.job_id;
                    } else {
                        const prompt = document.getElementById('video-prompt').value.trim();
                        const fd = new FormData();
                        fd.append('video', videoFile);
                        fd.append('prompt', prompt);
                        const r = await apiPostForm('/api/v1/video/track/text', fd);
                        jobId = r.job_id;
                    }

                    const job = await pollJob(jobId);
                    if (job.status !== 'succeeded') throw new Error(job.error?.message || 'job failed');
                    const outVideo = job.result?.files?.video;
                    if (!outVideo) throw new Error('no output video');

                    const v = document.getElementById('result-video');
                    v.src = outVideo;
                    v.classList.remove('hidden');
                    document.getElementById('video-placeholder').classList.add('hidden');
                    v.load();
                } catch (e) {
                    alert('跟踪失败：' + (e.message || e));
                } finally {
                    spinner.classList.add('hidden');
                    text.textContent = '开始跟踪';
                    btn.disabled = !hasVideo;
                }
            })();
        }
        
        // Drag and drop
        document.getElementById('image-drop-zone').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-500');
        });
        document.getElementById('image-drop-zone').addEventListener('dragleave', (e) => {
            e.currentTarget.classList.remove('border-blue-500');
        });
        document.getElementById('image-drop-zone').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-500');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file);
                document.getElementById('image-preview').src = url;
                document.getElementById('result-image').src = url;
                document.getElementById('image-drop-zone').classList.add('hidden');
                document.getElementById('image-preview-container').classList.remove('hidden');
                document.getElementById('image-placeholder').classList.add('hidden');
                document.getElementById('result-image').classList.remove('hidden');
                hasImage = true;
                updateSegmentButton();
            }
        });
    </script>
</body>
</html>